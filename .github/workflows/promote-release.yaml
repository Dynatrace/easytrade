name: Promote Release
on:
  workflow_call:
    inputs:
      version:
        description: 'Version tag to create'
        required: true
        type: string
      trigger-deploy:
        description: 'Whether to trigger the deploy workflow'
        required: false
        type: boolean
        default: false
      deploy-workflow-name:
        description: 'The name of the deploy workflow to trigger'
        required: false
        type: string
        default: 'deploy.yaml'

jobs:
  promote:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Create release
        uses: actions/github-script@v8
        with:
          script: |
            const version = '${{ inputs.version }}';

            // Create tag
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${version}`,
              sha: context.sha
            });

            // Create release
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              generate_release_notes: true,
              draft: false,
              prerelease: false
            });

      - name: Trigger deploy workflow
        uses: actions/github-script@v8
        if: ${{ inputs.trigger-deploy }}
        with:
          script: |
            const workflowName = '${{ inputs.deploy-workflow-name }}';
            const version = '${{ inputs.version }}';

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowName,
              ref: version
            });
