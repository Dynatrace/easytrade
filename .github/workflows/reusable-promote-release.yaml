name: Promote Release
on:
  workflow_call:
    inputs:
      version:
        description: "Version tag to create"
        required: true
        type: string
      trigger-deploy:
        description: "Whether to trigger the deploy workflow"
        required: false
        type: boolean
        default: false
      deploy-workflow-name:
        description: "The name of the deploy workflow to trigger"
        required: false
        type: string
        default: "deploy.yaml"
      artifact-name:
        description: "Name of the artifact to download from the build job"
        required: false
        type: string
      artifact-dir:
        description: "Directory containing build artifacts to upload to the release"
        required: false
        type: string

jobs:
  promote:
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      actions: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download build artifacts
        if: ${{ inputs.artifact-name }}
        uses: actions/download-artifact@v7
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.artifact-dir }}

      - name: Create release
        id: create-release
        uses: actions/github-script@v8
        with:
          script: |
            const version = 'v${{ inputs.version }}';

            // Create tag
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/tags/${version}`,
              sha: context.sha
            });

            // Create release
            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: version,
              name: version,
              generate_release_notes: true,
              draft: false,
              prerelease: false
            });

            core.setOutput('release-id', release.data.id);

      - name: Upload release assets
        if: ${{ inputs.artifact-dir }}
        uses: actions/github-script@v8
        env:
          ARTIFACT_DIR: ${{ inputs.artifact-dir }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const artifactDir = process.env.ARTIFACT_DIR;
            const releaseId = ${{ steps.create-release.outputs.release-id }};

            // Check if artifact directory exists
            if (!fs.existsSync(artifactDir)) {
              console.log(`Artifact directory not found: ${artifactDir}`);
              return;
            }

            const files = fs.readdirSync(artifactDir);

            for (const file of files) {
              const filePath = path.join(artifactDir, file);
              const fileStats = fs.statSync(filePath);

              // Skip directories
              if (fileStats.isDirectory()) {
                continue;
              }

              console.log(`Uploading artifact: ${file}`);

              const fileData = fs.readFileSync(filePath);

              await github.rest.repos.uploadReleaseAsset({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: releaseId,
                name: file,
                data: fileData,
                headers: {
                  'content-type': 'application/octet-stream',
                  'content-length': fileStats.size
                }
              });
            }

      - name: Trigger deploy workflow
        uses: actions/github-script@v8
        if: ${{ inputs.trigger-deploy }}
        with:
          script: |
            const workflowName = '${{ inputs.deploy-workflow-name }}';
            const version = 'v${{ inputs.version }}';

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowName,
              ref: version
            });
