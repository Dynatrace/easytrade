name: 'Build and Push Helm Chart'
description: 'Lint, build, and optionally push Helm chart to Google Artifact Registry'
inputs:
  chart-path:
    description: 'Path to the Helm chart directory'
    required: true
  push:
    description: 'Whether to push the chart to registry'
    required: false
    default: 'false'
  registry-url:
    description: 'Google Artifact Registry URL (e.g., oci://europe-docker.pkg.dev/project/helm-charts)'
    required: false
  credentials:
    description: 'Base64 encoded Google service account JSON credentials'
    required: false
  version:
    description: 'Chart version (defaults to 0.0.0-{sha})'
    required: false
  app-version:
    description: 'App version (defaults to git sha)'
    required: false

outputs:
  chart-name:
    description: 'Name of the packaged chart file'
    value: ${{ steps.package.outputs.chart-name }}
  chart-version:
    description: 'Version of the packaged chart'
    value: ${{ steps.set-version.outputs.version }}

runs:
  using: 'composite'
  steps:
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: 'latest'

    - name: Set version
      id: set-version
      shell: bash
      run: |
        if [ -n "${{ inputs.version }}" ]; then
          VERSION="${{ inputs.version }}"
        else
          VERSION="0.0.0-${{ github.sha }}"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
        if [ -n "${{ inputs.app-version }}" ]; then
          APP_VERSION="${{ inputs.app-version }}"
        else
          APP_VERSION="${{ github.sha }}"
        fi
        echo "app-version=$APP_VERSION" >> $GITHUB_OUTPUT

    - name: Update Helm dependencies
      shell: bash
      run: helm dependency update ${{ inputs.chart-path }}

    - name: Lint Helm chart
      shell: bash
      run: helm lint ${{ inputs.chart-path }}

    - name: Package Helm chart
      id: package
      shell: bash
      run: |
        helm package ${{ inputs.chart-path }} \
          --version ${{ steps.set-version.outputs.version }} \
          --app-version ${{ steps.set-version.outputs.app-version }}
        
        CHART_NAME=$(ls -1 *.tgz | head -n1)
        echo "chart-name=$CHART_NAME" >> $GITHUB_OUTPUT

    - name: Authenticate to Google Artifact Registry
      if: inputs.push == 'true'
      shell: bash
      run: |
        echo "${{ inputs.credentials }}" | base64 -d > /tmp/gcloud-key.json
        cat /tmp/gcloud-key.json | helm registry login -u _json_key --password-stdin https://europe-docker.pkg.dev

    - name: Push Helm chart
      if: inputs.push == 'true'
      shell: bash
      run: |
        helm push ${{ steps.package.outputs.chart-name }} ${{ inputs.registry-url }}

    - name: Cleanup credentials
      if: always() && inputs.push == 'true'
      shell: bash
      run: |
        rm -f /tmp/gcloud-key.json
